@page "/facturacion"

@inject IJSRuntime JS
@inject ConsultaService ConsultaService

<h1 style="color:#06038D">
    <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -900 960 960" width="40px" fill="#06038D"><path d="M440-200h80v-40h40q17 0 28.5-11.5T600-280v-120q0-17-11.5-28.5T560-440H440v-40h160v-80h-80v-40h-80v40h-40q-17 0-28.5 11.5T360-520v120q0 17 11.5 28.5T400-360h120v40H360v80h80v40ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-560v-160H240v640h480v-480H520ZM240-800v160-160 640-640Z" /></svg>
    <strong>Facturacion - @nombreCliente</strong>
</h1>

@if (_loading)
{
    <p>Cargando datos...</p>
}
else
{
    <div id="ventasChart" style="width: 100%; height: 500px;"></div>
}

@code{
    private bool _loading = true;
    private List<Facturacion> _datos = new();
    private string? nombreCliente;

    private static readonly string[] MonthColors = new[]
    {
        "#06038D", "#FCE300", "#911A00", "#FFB600",
        "#008080", "#9966FF", "#3BD4B1", "#881C9E",
        "#36A2EB", "#6A5ACD", "#FF8C00", "#225E87"
    };
    
    private static readonly string[] MonthNames =
    {
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    };

    protected override async Task OnInitializedAsync()
    {
        _datos = await ConsultaService.GetFacturacion(212);
        nombreCliente = _datos.First().Nombre1;
        _loading = false;
    }

    protected override async Task OnAfterRenderAsync (bool firstRender)
    {
        if (_loading) return;
        await RenderChart();
    }

    private async Task RenderChart()
    {
        var anyoMes = _datos
            .GroupBy(f => f.FechaPedido.Year)
            .OrderBy(g => g.Key)
            .ToDictionary(
                g => g.Key,
                g => g.GroupBy(f => f.FechaPedido.Month - 1)
                        .ToDictionary(m => m.Key, m => m.Sum(f => (double)f.Vtotal))
            );

        var years = anyoMes.Keys.OrderBy(y => y).ToList();

        var series = years.Select((year, idx) => new
        {
            name = year.ToString(),
            type = "bar",
            barGap = "5%",
            label = new
            {
                show = false
            },
            data = Enumerable.Range(0, 12).Select(mesIdx =>
                anyoMes[year].TryGetValue(mesIdx, out var val) ? Math.Round(val, 2) : 0.0
            ).ToArray()
        }).ToArray();

        var option = new
        {
            tooltip = new
            {
                trigger = "axis",
                axisPointer = new { type = "shadow" },
                formatter = @"
                function (params) {
                    const month = params[0]?.axisValue ?? '';
                    const currency = new Intl.NumberFormat('es-ES', {
                        style: 'currency',
                        currency: 'EUR',
                        maximumFractionDigits: 0,
                        useGrouping: 'always'
                    });
                    let html = `<strong>${month}</strong><br/>`;

                    params.forEach(p => {
                        let v = typeof p.data === 'number' ? p.data : (p?.data?.value ?? 0);
                        if (v > 0) {
                            html += `${p.marker} <strong>${p.seriesName}</strong>: ${currency.format(v)}<br/>`;
                        }
                    });

                    return html;
                }
            "
            },
            legend = new
            {
                data = years.Select(y => y.ToString()).ToArray(),
                bottom = 0,
                type = "scroll",
                selected = years.ToDictionary(
                    y => y.ToString(),
                    y => y >= years.Max() - 1
                )
            },
            grid = new
            {
                left = "3%",
                right = "4%",
                bottom = "10%",
                containLabel = true
            },
            xAxis = new
            {
                type = "category",
                data = MonthNames,
                axisLabel = new { rotate = 30 }
            },
            yAxis = new
            {
                type = "value",
                axisLabel = new { formatter = "{value} €" }
            },
            series
        };

        await JS.InvokeVoidAsync("renderEChart", "ventasChart", option);
    }
}