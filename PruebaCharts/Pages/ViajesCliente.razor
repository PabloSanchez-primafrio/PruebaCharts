@page "/viajes"

@inject ConsultaService ConsultaService
@inject IJSRuntime JS

<div class="container mt-4">
    <h2>Viajes</h2>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2"><em>Cargando datos...</em></p>
        </div>
    }
    else if (consultaViajes == null || !consultaViajes.Any())
    {
        <div class="alert alert-warning" role="alert">
            No se encontraron datos para el cliente @clienteId
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div id="viajesChart" style="width: 100%; height:500px;"></div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {

    private List<NumViajes>? consultaViajes;
    private bool isLoading = true;
    private int clienteId = 212;
    private bool graficaRenderizada = false;
    private string? clienteNombre;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!graficaRenderizada && !isLoading && consultaViajes != null && consultaViajes.Any())
        {
            graficaRenderizada = true;
            await RenderGraphic();
        }
    }

    private async Task CargarDatos()
    {
        isLoading = true;
        graficaRenderizada = false;
        StateHasChanged();

        try
        {
            consultaViajes = await ConsultaService.GetNumViajes(clienteId);

            if (consultaViajes != null && consultaViajes.Any())
            {
                clienteNombre = consultaViajes.First().NombreCliente;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            consultaViajes = new List<NumViajes>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RenderGraphic()
    {
        if (consultaViajes == null || !consultaViajes.Any())
            return;

        var datosPorAnyoMes = consultaViajes
            .GroupBy(v => new { v.Anyo, v.Mes })
            .Select(g => new
            {
                g.Key.Anyo,
                g.Key.Mes,
                TotalViajes = g.Sum(v => v.NumeroViajes)
            })
            .OrderBy(x => x.Anyo)
            .ThenBy(x => x.Mes)
            .ToList();

        var anyos = datosPorAnyoMes.Select(d => d.Anyo).Distinct().OrderBy(a => a).ToList();

        var meses = new[] { "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre" };

        var series = anyos.Select(anyo => new
        {
            name = anyo.ToString(),
            type = "bar",
            barGap = "5%",
            label = new
            {
                show = false
            },
            emphasis = new { focus = "series" },
            data = Enumerable.Range(1, 12).Select(mes =>
                datosPorAnyoMes.FirstOrDefault(d => d.Anyo == anyo && d.Mes == mes)?.TotalViajes ?? 0
            ).ToArray()
        }).ToArray();

        var options = new
        {
            title = new
            {
                text = $"Viajes por Mes - {clienteNombre ?? "Cliente " + clienteId}",
                left = "center"
            },
            tooltip = new
            {
                trigger = "axis",
                axisPointer = new
                {
                    type = "cross",
                    label = new { backgroundColor = "#6A7985" }
                }
            },
            legend = new
            {
                data = anyos.Select(a => a.ToString()).ToArray(),
                top = "30px",
                type = "scroll",
                selected = anyos.ToDictionary(
                    y => y.ToString(),
                    y => y >= anyos.Max() - 1
                )
            },
            toolbox = new
            {
                feature = new
                {
                    saveAsImage = new { title = "Guardar Imagen" }
                }
            },
            grid = new
            {
                left = "3%",
                right = "4%",
                bottom = "3%",
                containLabel = true
            },
            xAxis = new
            {
                type = "category",
                data = meses
            },
            yAxis = new
            {
                type = "value",
                name = "Número de Viajes"
            },
            series = series.ToArray()
        };

        try
        {
            await JS.InvokeVoidAsync("renderEChart", "viajesChart", options);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error renderizando gráfico: {ex.Message}");
        }
    }
}