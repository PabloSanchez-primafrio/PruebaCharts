@page "/cargas"

@inject IJSRuntime JS
@inject ConsultaService ConsultaService
@implements IAsyncDisposable

<PageTitle>Gestión de Cargas</PageTitle>

<div class="d-flex justify-content-between align-items-center">
    <h1 style="color:#06038D">
        <strong>
            <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -900 960 960" width="40px" fill="#06038D"><path d="M160-200h80v-320h480v320h80v-426L480-754 160-626v426Zm-80 80v-560l400-160 400 160v560H640v-320H320v320H80Zm280 0v-80h80v80h-80Zm80-120v-80h80v80h-80Zm80 120v-80h80v80h-80ZM240-520h480-480Z" /></svg>
            Cargas - @nombreCliente
        </strong>
    </h1>
    @if (trayectoSeleccionado != null)
    {
        <div class="row mb-2">
            <div class="col-12">
                <button class="btn" style="background-color:#06038D; color:white; margin-right:10px;" @onclick="VolverALista">
                    Volver a la lista
                </button>
            </div>
        </div>
    }
</div>

<div class="container-fluid mt-0">

    @if (trayectoSeleccionado == null)
    {
        <div class="row justify-content-center">
            <div class="col-12 d-flex flex-column">
                <div class="card flex-grow-1 d-flex flex-column">
                    <div class="card-body p-0 d-flex flex-column">

                        @if (isLoading)
                        {
                            <div class="text-center my-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2"><em>Cargando datos...</em></p>
                            </div>
                        }
                        else if (!trayectos.Any())
                        {
                            <div class="alert alert-warning m-2">No se encontraron trayectos.</div>
                        }
                        else
                        {
                            <div class="card mb-2 mx-2 mt-2">
                                <div class="card-body py-2">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold">ID Trayecto</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   placeholder="Buscar por ID Trayecto..."
                                                   @bind="filtroBusqueda" @bind:event="oninput" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold">Fecha</label>
                                            <input type="date" class="form-control form-control-sm"
                                                   @bind="filtroFecha" @bind:event="oninput" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="max-height: calc(100vh - 220px); overflow-y: auto;">
                                @if (!string.IsNullOrEmpty(filtroBusqueda) || filtroFecha != null)
                                {
                                    var resultados = trayectos
                                        .Where(t =>
                                            (string.IsNullOrEmpty(filtroBusqueda) || t.Key.ToString().Contains(filtroBusqueda)) &&
                                            (filtroFecha == null || t.Value.First().FechaTrabajo.Date == filtroFecha.Value.Date)
                                        ).ToList();

                                    @if (!resultados.Any())
                                    {
                                        <div class="alert alert-danger m-2">No se encontraron trayectos.</div>
                                    }
                                    else
                                    {
                                        <table class="table table-hover mb-0">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th></th>
                                                    <th>ID Trayecto</th>
                                                    <th>Matricula</th>
                                                    <th>Fecha</th>
                                                    <th class="text-end">Palets Totales</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var trayecto in resultados.Where(t => CalcularOcupacion(t.Value) <= 1))
                                                {
                                                    var estaExpandido = trayectosExpandidos.Contains(trayecto.Key.ToString());
                                                    var estaSeleccionado = trayectoSeleccionado == trayecto.Key;

                                                    <tr class="@(estaSeleccionado ? "table-primary" : "")"
                                                        style="cursor:pointer"
                                                        @onclick="() => ToggleTrayecto(trayecto.Key)">
                                                        <td></td>
                                                        <td><strong>@trayecto.Key</strong></td>
                                                        <td>@trayecto.Value.First().Matricula</td>
                                                        <td>@trayecto.Value.First().FechaTrabajo.ToShortDateString()</td>
                                                        <td class="text-end">@trayecto.Value.Sum(c => c.NumeroPalets)</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    }
                                }
                                else
                                {
                                    <table class="table table-hover mb-0">
                                        <tbody>
                                            @foreach (var anyo in trayectosPorAnyoMes)
                                            {
                                                var anyoExpandido = anyosExpandidos.Contains(anyo.Key);

                                                <tr class="table-secondary fw-bold"
                                                    style="cursor:pointer"
                                                    @onclick="() => ToggleAnyo(anyo.Key)">
                                                    <td style="width:30px">
                                                        <span>@(anyoExpandido ? "▾" : "▸")</span>
                                                    </td>
                                                    <td colspan="4">
                                                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M578-80q-17 0-28.5-11.5T538-120q0-17 11.5-28.5T578-160h113l-92-65q-14-10-16.5-25.5T589-280q9-14 25-16.5t30 6.5l93 64-39-106q-6-15 1-30t23-21q16-6 31 1t21 23l38 106 30-109q5-16 18.5-24.5T890-390q16 5 25 18.5t4 29.5L849-80H578Zm-378-80q-33 0-56.5-23.5T120-240v-480q0-33 23.5-56.5T200-800h40v-80h80v80h240v-80h80v80h40q33 0 56.5 23.5T760-720v244q-20-3-40-3t-40 3v-84H200v320h280q0 20 3 40t11 40H200Zm0-480h480v-80H200v80Zm0 0v-80 80Z" /></svg>
                                                        @anyo.Key
                                                    </td>
                                                </tr>

                                                @if (anyoExpandido)
                                                {
                                                    @foreach (var mes in anyo.Value)
                                                    {
                                                        var mesKey = $"{anyo.Key}-{mes.Key}";
                                                        var mesExpandido = mesesExpandidos.Contains(mesKey);

                                                        <tr class="table-light fw-semibold"
                                                            style="cursor:pointer"
                                                            @onclick="() => ToggleMes(mesKey)">
                                                            <td class="ps-3" style="width:30px">
                                                                <span>@(mesExpandido ? "▾" : "▸")</span>
                                                            </td>
                                                            <td colspan="4" class="ps-3">
                                                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-188.5-11.5Q280-423 280-440t11.5-28.5Q303-480 320-480t28.5 11.5Q360-457 360-440t-11.5 28.5Q337-400 320-400t-28.5-11.5ZM640-400q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-188.5-11.5Q280-263 280-280t11.5-28.5Q303-320 320-320t28.5 11.5Q360-297 360-280t-11.5 28.5Q337-240 320-240t-28.5-11.5ZM640-240q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z" /></svg>
                                                                @NombreMes(mes.Key)
                                                            </td>
                                                        </tr>

                                                        @if (mesExpandido)
                                                        {
                                                            <tr class="table-dark">
                                                                <th></th>
                                                                <th>ID Trayecto</th>
                                                                <th>Matricula</th>
                                                                <th>Fecha</th>
                                                                <th class="text-end">Palets Totales</th>
                                                            </tr>
                                                            @foreach (var trayecto in mes.Value.Where(t => CalcularOcupacion(t.Value) <= 1))
                                                            {
                                                                var estaExpandido = trayectosExpandidos.Contains(trayecto.Key.ToString());
                                                                var estaSeleccionado = trayectoSeleccionado == trayecto.Key;

                                                                <tr class="@(estaSeleccionado ? "table-primary" : "")"
                                                                    style="cursor:pointer"
                                                                    @onclick="() => ToggleTrayecto(trayecto.Key)">
                                                                    <td></td>
                                                                    <td><strong>@trayecto.Key</strong></td>
                                                                    <td>@trayecto.Value.First().Matricula</td>
                                                                    <td>@trayecto.Value.First().FechaTrabajo.ToShortDateString()</td>
                                                                    <td class="text-end">@trayecto.Value.Sum(c => c.NumeroPalets)</td>
                                                                </tr>
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        }

                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        var cargas = trayectos[trayectoSeleccionado.Value];
        var tiposEuropalet = new[] { "H", "E", "N", "NE" };
        double ocupado = cargas.Sum(c =>
            tiposEuropalet.Contains(c.TipoPalets)
                ? (double) c.NumeroPalets / 33
                : (double) c.NumeroPalets / 26
        );

        <div class="row">
            <div class="col-12">
                <div class="row">
                    <div class="col-md-2">
                        <div class="card h-100" style="min-height: 380px;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M295-119q-36-1-68.5-18.5T165-189q-40-48-62.5-114.5T80-440q0-83 31.5-156T197-723q54-54 127-85.5T480-840q83 0 156 32t127 87q54 55 85.5 129T880-433q0 77-25 144t-71 113q-28 28-59 42.5T662-119q-18 0-36-4.5T590-137l-56-28q-12-6-25.5-9t-28.5-3q-15 0-28.5 3t-25.5 9l-56 28q-19 10-37.5 14.5T295-119Zm2-80q9 0 18.5-2t18.5-7l56-28q21-11 43.5-16t45.5-5q23 0 46 5t44 16l57 28q9 5 18 7t18 2q19 0 36-10t34-30q32-38 50-91t18-109q0-134-93-227.5T480-760q-134 0-227 94t-93 228q0 57 18.5 111t51.5 91q17 20 33 28.5t34 8.5Zm183-281Zm56.5 96.5Q560-407 560-440q0-8-1.5-16t-4.5-16l50-67q10 13 17.5 27.5T634-480h82q-15-88-81.5-144T480-680q-88 0-155 56.5T244-480h82q14-54 57-87t97-33q17 0 32 3t29 9l-51 69q-2 0-5-.5t-5-.5q-33 0-56.5 23.5T400-440q0 33 23.5 56.5T480-360q33 0 56.5-23.5Z" /></svg>
                                    Ocupación
                                </h6>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center w-100">
                                <div id="ocupacionGauge" style="width:100%; height:240px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100" style="min-height: 380px;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M80-120v-80h800v80H80Zm40-120v-280h120v280H120Zm200 0v-480h120v480H320Zm200 0v-360h120v360H520Zm200 0v-600h120v600H720Z" /></svg>
                                    Resumen del trayecto
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col">
                                        <div class="fw-semibold text-muted small">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M80-80v-160h800v160H760v-80H540v80H420v-80H200v80H80Zm160-240q-17 0-28.5-11.5T200-360v-480q0-17 11.5-28.5T240-880h480q17 0 28.5 11.5T760-840v480q0 17-11.5 28.5T720-320H240Zm40-80h400v-400H280v400Zm80-240h240v-80H360v80Zm-80 240v-400 400Z" /></svg>
                                            ID Trayecto
                                        </div>
                                        <div class="fs-5 fw-bold">@cargas.Sum(c => c.NumeroPalets)</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-semibold text-muted small">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M80-80v-160h800v160H760v-80H540v80H420v-80H200v80H80Zm160-240q-17 0-28.5-11.5T200-360v-480q0-17 11.5-28.5T240-880h480q17 0 28.5 11.5T760-840v480q0 17-11.5 28.5T720-320H240Zm40-80h400v-400H280v400Zm80-240h240v-80H360v80Zm-80 240v-400 400Z" /></svg>
                                            Palets totales
                                        </div>
                                        <div class="fs-5 fw-bold">@cargas.Sum(c => c.NumeroPalets)</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-semibold text-muted small">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M80-80v-160h800v160H760v-80H540v80H420v-80H200v80H80Zm160-240q-17 0-28.5-11.5T200-360v-480q0-17 11.5-28.5T240-880h480q17 0 28.5 11.5T760-840v480q0 17-11.5 28.5T720-320H240Zm40-80h400v-400H280v400Zm80-240h240v-80H360v80Zm-80 240v-400 400Z" /></svg>
                                            Fecha
                                        </div>
                                        <div class="fs-5 fw-bold">@cargas.Sum(c => c.NumeroPalets)</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-semibold text-muted small">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M247-167q-47-47-47-113v-327q-35-13-57.5-43.5T120-720q0-50 35-85t85-35q50 0 85 35t35 85q0 39-22.5 69.5T280-607v327q0 33 23.5 56.5T360-200q33 0 56.5-23.5T440-280v-400q0-66 47-113t113-47q66 0 113 47t47 113v327q35 13 57.5 43.5T840-240q0 50-35 85t-85 35q-50 0-85-35t-35-85q0-39 22.5-70t57.5-43v-327q0-33-23.5-56.5T600-760q-33 0-56.5 23.5T520-680v400q0 66-47 113t-113 47q-66 0-113-47Zm-7-513q17 0 28.5-11.5T280-720q0-17-11.5-28.5T240-760q-17 0-28.5 11.5T200-720q0 17 11.5 28.5T240-680Zm480 480q17 0 28.5-11.5T760-240q0-17-11.5-28.5T720-280q-17 0-28.5 11.5T680-240q0 17 11.5 28.5T720-200ZM240-720Zm480 480Z" /></svg>
                                            Kilometros Totales
                                        </div>
                                        <div class="fs-5 fw-bold">@cargas.First().KmTotal</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-semibold text-muted small">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M160-120q-50 0-85-35t-35-85q0-26 10-49.5T80-330v-190h80v-240h320l188 443q6 14 9 28t3 29q0 58-41 99t-99 41q-41 0-75.5-21.5T413-200H273q-13 36-44 58t-69 22Zm560-40v-640h80v560h120v80H720Zm-531.5-51.5Q200-223 200-240t-11.5-28.5Q177-280 160-280t-28.5 11.5Q120-257 120-240t11.5 28.5Q143-200 160-200t28.5-11.5Zm394-6Q600-235 600-260t-17.5-42.5Q565-320 540-320t-42.5 17.5Q480-285 480-260t17.5 42.5Q515-200 540-200t42.5-17.5ZM273-280h128q2-11 4.5-20.5T413-320h-90L206-440h-46v80q38 0 69 22t44 58Zm84-120h189L427-680H240v160l117 120Zm-34 80-18.5-19q-18.5-19-40-41.5t-40-41L206-440h-46 46l117 120h90-90Z" /></svg>
                                            Nº de Cargas
                                        </div>
                                        <div class="fs-5 fw-bold txt-success">@cargas.Where(c => !string.IsNullOrEmpty(c.PaisCarga)).GroupBy(c => c.NombreLugarCarga).Count()</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-semibold text-muted small">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="m720-80 120-120-28-28-72 72v-164h-40v164l-72-72-28 28L720-80ZM480-800 243-663l237 137 237-137-237-137ZM120-321v-318q0-22 10.5-40t29.5-29l280-161q10-5 19.5-8t20.5-3q11 0 21 3t19 8l280 161q19 11 29.5 29t10.5 40v159h-80v-116L479-434 200-596v274l240 139v92L160-252q-19-11-29.5-29T120-321ZM578.5-58.5Q520-117 520-200t58.5-141.5Q637-400 720-400t141.5 58.5Q920-283 920-200T861.5-58.5Q803 0 720 0T578.5-58.5ZM480-491Z" /></svg>
                                            Nº de Descargas
                                        </div>
                                        <div class="fs-5 fw-bold txt-success">@cargas.Where(c => !string.IsNullOrEmpty(c.PaisDescarga)).GroupBy(c => c.NombreLugarDescarga).Count()</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100" style="min-height: 380px;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M307-113.5Q240-147 240-200q0-24 14.5-44.5T295-280l63 59q-9 4-19.5 9T322-200q13 16 60 28t98 12q51 0 98.5-12t60.5-28q-7-8-18-13t-21-9l62-60q28 16 43 36.5t15 45.5q0 53-67 86.5T480-80q-106 0-173-33.5ZM481-300q99-73 149-146.5T680-594q0-102-65-154t-135-52q-70 0-135 52t-65 154q0 67 49 139.5T481-300Zm-1 100Q339-304 269.5-402T200-594q0-71 25.5-124.5T291-808q40-36 90-54t99-18q49 0 99 18t90 54q40 36 65.5 89.5T760-594q0 94-69.5 192T480-200Zm0-320q33 0 56.5-23.5T560-600q0-33-23.5-56.5T480-680q-33 0-56.5 23.5T400-600q0 33 23.5 56.5T480-520Zm0-80Z" /></svg>
                                    Cargas y Descargas
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6 border-end">
                                        <h6 class="text-center fw-bold mb-3" style="color:#DEC000">
                                            Carga
                                        </h6>
                                        @foreach (var pais in cargas
                                                                            .Where(c => !string.IsNullOrEmpty(c.PaisCarga))
                                                                            .GroupBy(c => c.PaisCarga)
                                                                            .OrderByDescending(g => g.Sum(c => c.NumeroPalets)))
                                        {
                                            <div class="mb-3">
                                                <div class="fw-semibold d-flex align-items-center gap-1 mb-1"
                                                     style="color:#DEC000; font-size:0.9rem;">
                                                    <span><strong>@pais.Key</strong></span>
                                                </div>
                                                @foreach (var lugar in pais
                                                                                        .GroupBy(c => c.NombreLugarCarga)
                                                                                        .Where(g => !string.IsNullOrEmpty(g.Key))
                                                                                        .OrderByDescending(g => g.Sum(c => c.NumeroPalets)))
                                                {
                                                    <div class="d-flex justify-content-between align-items-center
                                                                                ps-2 py-1 mb-1 rounded"
                                                         style="background:#fffbde; font-size:0.82rem;">
                                                        <span class="text-muted">
                                                            <svg xmlns="http://www.w3.org/2000/svg" height="14px"
                                                                 viewBox="0 -960 960 960" width="14px" fill="#6B7280">
                                                                <path d="M480-480q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0 294q122-112 181-203.5T720-560q0-109-69.5-174.5T480-800q-101 0-170.5 65.5T240-560q0 71 59 162.5T480-186Z" />
                                                            </svg>
                                                            @lugar.Key
                                                        </span>
                                                        <span class="badge rounded-pill ms-2"
                                                              style="background:#DEC000; font-size:0.75rem;">
                                                            @lugar.Sum(c => c.NumeroPalets) pal
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-center fw-bold mb-3" style="color:#06038D">
                                            Descarga
                                        </h6>
                                        @foreach (var pais in cargas
                                                                            .Where(c => !string.IsNullOrEmpty(c.PaisDescarga))
                                                                            .GroupBy(c => c.PaisDescarga)
                                                                            .OrderByDescending(g => g.Sum(c => c.NumeroPalets)))
                                        {
                                            <div class="mb-3">
                                                <div class="fw-semibold d-flex align-items-center gap-1 mb-1"
                                                     style="color:#06038D; font-size:0.9rem;">
                                                    <span><strong>@pais.Key</strong></span>
                                                </div>
                                                @foreach (var lugar in pais
                                                                                        .GroupBy(c => c.NombreLugarDescarga)
                                                                                        .Where(g => !string.IsNullOrEmpty(g.Key))
                                                                                        .OrderByDescending(g => g.Sum(c => c.NumeroPalets)))
                                                {
                                                    <div class="d-flex justify-content-between align-items-center
                                                                                ps-2 py-1 mb-1 rounded"
                                                         style="background:#f0f4ff; font-size:0.82rem;">
                                                        <span class="text-muted">
                                                            <svg xmlns="http://www.w3.org/2000/svg" height="14px"
                                                                 viewBox="0 -960 960 960" width="14px" fill="#6B7280">
                                                                <path d="M480-480q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0 294q122-112 181-203.5T720-560q0-109-69.5-174.5T480-800q-101 0-170.5 65.5T240-560q0 71 59 162.5T480-186Z" />
                                                            </svg>
                                                            @lugar.Key
                                                        </span>
                                                        <span class="badge rounded-pill ms-2"
                                                              style="background:#06038D; font-size:0.75rem;">
                                                            @lugar.Sum(c => c.NumeroPalets) pal
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <br />
                <div class="row">

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="m600-120-240-84-186 72q-20 8-37-4.5T120-170v-560q0-13 7.5-23t20.5-15l212-72 240 84 186-72q20-8 37 4.5t17 33.5v560q0 13-7.5 23T812-192l-212 72Zm-40-98v-468l-160-56v468l160 56Zm80 0 120-40v-474l-120 46v468Zm-440-10 120-46v-468l-120 40v474Zm440-458v468-468Zm-320-56v468-468Z" /></svg>
                                    Mapa
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="europaMap" style="height: 350px; width:100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#06038D"><path d="M155-195q-35-35-35-85H40v-440q0-33 23.5-56.5T120-800h560v160h120l120 160v200h-80q0 50-35 85t-85 35q-50 0-85-35t-35-85H360q0 50-35 85t-85 35q-50 0-85-35Zm113.5-56.5Q280-263 280-280t-11.5-28.5Q257-320 240-320t-28.5 11.5Q200-297 200-280t11.5 28.5Q223-240 240-240t28.5-11.5ZM120-360h32q17-18 39-29t49-11q27 0 49 11t39 29h272v-360H120v360Zm628.5 108.5Q760-263 760-280t-11.5-28.5Q737-320 720-320t-28.5 11.5Q680-297 680-280t11.5 28.5Q703-240 720-240t28.5-11.5ZM680-440h170l-90-120h-80v120ZM360-540Z" /></svg>
                                    Carga
                                </h6>
                            </div>
                            <div class="card-body p-0 align-content-center">
                                <div class="d-flex justify-content-center pt-2 pb-1">
                                    <div style="position:relative; width:160px; height:40px; display:inline-block; margin-right: 10px;">
                                        <img src="/img/MatriculaRemolque.png"
                                             style="position:absolute; top:0; left:0; width: 100%; height:100%; object-fit:contain; z-index:1;" />
                                        <div style="position:absolute; top:0; left:0;width:100%; height:100%;
                                            display:flex; align-items:center; justify-content:center;
                                            color:#000000; font-weight:bold; font-size:20px; z-index:2;">
                                            @matricula
                                        </div>
                                    </div>
                                </div>
                                <div id="truckMap" style="height:293px"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

</div>

@code {
    private IJSObjectReference? _module;
    private IJSObjectReference? _mapaModule;
    private bool _disposed;
    private bool isLoading = true;
    private int clienteId = 212;

    private Dictionary<int, List<PaletsTotales>> trayectos = new();
    private Dictionary<int, Dictionary<int, Dictionary<int, List<PaletsTotales>>>> trayectosPorAnyoMes = new();

    private int? trayectoSeleccionado;
    private HashSet<int> anyosExpandidos = new();
    private HashSet<string> mesesExpandidos = new();
    private HashSet<string> trayectosExpandidos = new();

    private string? matricula;
    private string? nombreCliente;
    private string? filtroBusqueda;
    private DateTime? filtroFecha;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var datos = await ConsultaService.GetCarga(clienteId);

            nombreCliente = datos.First().NombreCliente;

            trayectos = datos.GroupBy(p => p.Trayecto).ToDictionary(g => g.Key, g => g.ToList());

            trayectosPorAnyoMes = trayectos.GroupBy(t => t.Value.First().FechaTrabajo.Year)
                                           .OrderByDescending(g => g.Key)
                                           .ToDictionary(
                                                gAnyo => gAnyo.Key,
                                                gAnyo => gAnyo
                                                      .GroupBy(t => t.Value.First().FechaTrabajo.Month)
                                                      .OrderBy(g => g.Key)
                                                      .ToDictionary(
                                                          gMes => gMes.Key,
                                                          gMes => gMes
                                                               .OrderBy(t => t.Value.First().FechaTrabajo)
                                                               .ToDictionary(t => t.Key, t => t.Value)
                                                      )
                                            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void VolverALista()
    {
        trayectoSeleccionado = null;
        trayectosExpandidos.Clear();
    }

    private void ToggleAnyo(int anyo)
    {
        if (anyosExpandidos.Contains(anyo))
            anyosExpandidos.Remove(anyo);
        else
            anyosExpandidos.Add(anyo);
    }

    private void ToggleMes(string mesKey)
    {
        if (mesesExpandidos.Contains(mesKey))
            mesesExpandidos.Remove(mesKey);
        else
            mesesExpandidos.Add(mesKey);
    }

    private async Task ToggleTrayecto(int idTrayecto)
    {
        if (trayectosExpandidos.Contains(idTrayecto.ToString()))
            trayectosExpandidos.Remove(idTrayecto.ToString());
        else
            trayectosExpandidos.Add(idTrayecto.ToString());

        trayectoSeleccionado = idTrayecto;
        matricula = trayectos[trayectoSeleccionado.Value].First().Matricula.Replace("-", "  ");
        StateHasChanged();

        await Task.Delay(50);

        var cargas = trayectos[idTrayecto];
        var tiposEuropalet = new[] { "H", "E", "N", "NE" };
        double ocupado = cargas.Sum(c =>
            tiposEuropalet.Contains(c.TipoPalets)
                ? (double)c.NumeroPalets / 33
                : (double)c.NumeroPalets / 26
        );
        double pct = Math.Round(ocupado * 100, 1);

        await RenderRemolque();
        await RenderGauge();
        await RenderMercanciaDonut();
    }

    private static string NombreMes(int mes) => mes switch
    {
        1 => "Enero",
        2 => "Febrero",
        3 => "Marzo",
        4 => "Abril",
        5 => "Mayo",
        6 => "Junio",
        7 => "Julio",
        8 => "Agosto",
        9 => "Septiembre",
        10 => "Octubre",
        11 => "Noviembre",
        12 => "Diciembre",
        _ => mes.ToString()
    };

    private double CalcularOcupacion(IEnumerable<PaletsTotales> cargas)
    {
        var europalet = new HashSet<string> { "H", "E", "N", "NE" };

        return cargas.Sum(c =>
        {
            double capacidad = europalet.Contains(c.TipoPalets) ? 33.0 : 26.0;
            return (double)c.NumeroPalets / capacidad;
        });
    }

    protected async Task RenderGauge()
    {
        if (trayectoSeleccionado == null || _disposed) return;

        var cargas = trayectos[trayectoSeleccionado.Value];
        var tiposEuropalet = new[] { "H", "E", "N", "NE" };

        double ocupado = cargas.Sum(c =>
            tiposEuropalet.Contains(c.TipoPalets)
                ? (double)c.NumeroPalets / 33
                : (double)c.NumeroPalets / 26
        );

        double pct = Math.Round(ocupado * 100, 1);
        string color = GetInterpolatedColor(pct);

        var options = new
        {
            series = new[]
            {
                new
                {
                    type = "gauge",
                    startAngle = 210,
                    endAngle = -30,
                    min = 0,
                    max = 100,
                    radius = "88%",
                    center = new[] { "50%", "58%" },
                    progress = new
                    {
                        show = true,
                        width = 18,
                        itemStyle = new { color = color }
                    },
                    axisLine = new
                    {
                        lineStyle = new
                        {
                            width = 18,
                            color = new object[] { new object[] { 1, "#babcbf" } }
                        }
                    },
                    pointer = new { show = false },
                    axisTick = new { show = false },
                    splitLine = new { show = false },
                    axisLabel = new { show = false },
                    detail = new
                    {
                        valueAnimation = true,
                        formatter = "{value}%",
                        color = color,
                        fontSize = 28,
                        fontWeight = "bold",
                        offsetCenter = new[]{ "0%", "10%" }
                    },
                    title = new
                    {
                        show = true,
                        offsetCenter = new[] { "0%", "40%" },
                        fontSize = 13,
                        color = "000000",
                        fontWeight = "bold"
                    },
                    data = new[]
                    {
                        new { value = pct, name = "Ocupación" }
                    }
                }
            }
        };

        try
        {
            await JS.InvokeVoidAsync("renderEChart", "ocupacionGauge", options);
        }
        catch (JSDisconnectedException) { }
        catch (Exception ex)
        {
            Console.WriteLine($"Error gauge: {ex.Message}");
        }
    }

    protected async Task RenderMercanciaDonut()
    {
        if (trayectoSeleccionado == null || _disposed) return;

        var cargas = trayectos[trayectoSeleccionado.Value];

        var tiposEuropalet = new[] { "H", "E", "N", "NE" };

        double espacioOcupado = cargas.Sum(c =>
            tiposEuropalet.Contains(c.TipoPalets)
                ? (double)c.NumeroPalets / 33
                : (double)c.NumeroPalets / 26
        );

        double espacioLibre = Math.Round(Math.Max(0, 1 - espacioOcupado) * 100, 1);

        var grupos = cargas
            .GroupBy(c => c.Mercancia)
            .Select(g => new
            {
                name = g.Key,
                value = g.Sum(c => c.NumeroPalets)
            })
            .ToArray();

        var data = grupos.Select((g, i) => new
        {
            name = g.name,
            value = g.value,
            itemStyle = new
            {
                borderRadius = 10,
                borderColor = "#fff",
                borderWidth = 3
            }
        }).ToArray<object>();

        var options = new
        {
            backgroundColor = "transparent",
            tooltip = new
            {
                trigger = "item",
                formatter = "{b}: {c} palets ({d}%)"
            },
            legend = new
            {
                bottom = "2%",
                left = "center",
                textStyle = new { color = "#6B7280", fontSize = 11 }
            },
            series = new[]
            {
                new
                {
                    type = "pie",
                    radius = new[] { "45%", "70%" },
                    center = new[] { "50%", "45%" },
                    avoidLabelOverlap = false,
                    itemStyle = new
                    {
                        borderRadius = 10,
                        borderColor = "#fff",
                        borderWidth = 3
                    },
                    label = new { show = false, position = "center" },
                    emphasis = new
                    {
                        label = new
                        {
                            show = true,
                            fontSize = 18,
                            fontWeight = "bold",
                            formatter = "{c}\npalets"
                        },
                        itemStyle = new
                        {
                            shadowBlur = 16,
                            shadowColor = "rgba(99,102,241,0.35)"
                        },
                        scale = true,
                        scaleSize = 5
                    },
                    labelLine = new { show = false },
                    data
                }
            }
        };

        try
        {
            await JS.InvokeVoidAsync("renderEChart", "mercanciaDonutChart", options);
        }
        catch (JSDisconnectedException) { }
        catch (Exception ex)
        {
            Console.WriteLine($"Error mercanciaDonut: {ex.Message}");
        }
    }

    private string GetInterpolatedColor (double pct)
    {
        if(pct <= 50)
        {
            double t = pct / 50;
            return InterpolateColor("#D64550", "#E68F37", t);
        }
        else
        {
            double t = (pct - 50) / 50;
            return InterpolateColor("#E68F37", "#39B546", t);
        }
    }

    private string InterpolateColor (string hex1, string hex2, double t)
    {
        (int r1, int g1, int b1) = HexToRgb(hex1);
        (int r2, int g2, int b2) = HexToRgb(hex2);

        int r = (int)(r1 + (r2 - r1) * t);
        int g = (int)(g1 + (g2 - g1) * t);
        int b = (int)(b1 + (b2 - b1) * t);

        return $"#{r:X2}{g:X2}{b:X2}";
    }

    private (int r, int g, int b) HexToRgb (string hex)
    {
        hex = hex.Replace("#", "");
        return (
            Convert.ToInt32(hex.Substring(0, 2), 16),
            Convert.ToInt32(hex.Substring(2, 2), 16),
            Convert.ToInt32(hex.Substring(4, 2), 16)
        );
    }

    protected async Task RenderRemolque()
    {
        if (trayectoSeleccionado == null || _disposed)
            return;

        var cargas = trayectos[trayectoSeleccionado.Value];

        var tiposEuropalet = new[] { "H", "E", "N", "NE" };

        double espacioOcupado = cargas.Sum(c =>
            tiposEuropalet.Contains(c.TipoPalets)
                ? (double)c.NumeroPalets / 33
                : (double)c.NumeroPalets / 26
        );

        double espacioLibre = Math.Max(0, 1 - espacioOcupado);

        var datos = cargas.Select((c, i) => new
        {
            label = $"{c.TipoPalets}_{i + 1}",
            displayLabel = $"{c.TipoPalets} ({c.NumeroPalets})",
            value = Math.Round(
                tiposEuropalet.Contains(c.TipoPalets)
                    ? (double)c.NumeroPalets / 33 * 100
                    : (double)c.NumeroPalets / 26 * 100
                , 1)
        }).ToList<object>();

        if (espacioLibre > 0)
        {
            datos.Add(new
            {
                label = "Libre",
                displayLabel = "Libre",
                value = Math.Round(espacioLibre * 100, 1)
            });
        }

        try
        {
            _module ??= await JS.InvokeAsync<IJSObjectReference>(
                "import", "/js/remolqueChart.js");

            await _module.InvokeVoidAsync("initRemolque", "truckMap");
            await _module.InvokeVoidAsync("updateRemolque", datos, new
            {
                showLabels = true,
                labelKey = "label",
                displayLabelKey = "displayLabel",
                valueKey = "value",
                padding = 12
            });

            var lugaresCarga = cargas
                .Where(c => !string.IsNullOrEmpty(c.PaisCarga))
                .GroupBy(c => c.NombreLugarCarga)
                .Select(g =>
                {
                    var c = g.First();
                    bool tieneCoord = c.LatitudLugarCarga != 0 && c.LongitudLugarCarga != 0;
                    return new
                    {
                        nombre = c.NombreLugarCarga ?? c.PaisCarga,
                        pais = c.PaisCarga!,
                        lat = tieneCoord ? (double?)c.LatitudLugarCarga : null,
                        lng = tieneCoord ? (double?)c.LongitudLugarCarga : null
                    };
                })
                .ToList();

            var lugaresDescarga = cargas
                .Where(c => !string.IsNullOrEmpty(c.PaisDescarga))
                .GroupBy(c => c.NombreLugarDescarga)
                .Select(g =>
                {
                    var c = g.First();
                    bool tieneCoord = c.LatitudLugarDescarga != 0 && c.LongitudLugarDescarga != 0;
                    return new
                    {
                        nombre = c.NombreLugarDescarga ?? c.PaisDescarga,
                        pais = c.PaisDescarga!,
                        lat = tieneCoord ? (double?)c.LatitudLugarDescarga : null,
                        lng = tieneCoord ? (double?)c.LongitudLugarDescarga : null
                    };
                })
                .ToList();

            _mapaModule ??= await JS.InvokeAsync<IJSObjectReference>(
                "import", "/js/europaMap.js");

            await _mapaModule.InvokeVoidAsync("initEuropaMap", "europaMap", lugaresCarga, lugaresDescarga);
        }
        catch (JSDisconnectedException) { }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando remolque: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_disposed)
            return;

        _disposed = true;

        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch { }
        }

        if (_mapaModule is not null)
        {
            try { await _mapaModule.DisposeAsync(); } catch { }
        }
    }
}
