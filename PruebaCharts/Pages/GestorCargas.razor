@page "/cargas"

@inject IJSRuntime JS
@inject ConsultaService ConsultaService
@implements IAsyncDisposable

<PageTitle>Gestión de Cargas</PageTitle>

<h1 style="color:#06038D"><strong>🚛 Cargas - @nombreCliente</strong></h1>

<div class="container-fluid mt-3">
    <div class="row">

        <div class="col-md-5">
            <div class="card">

                <div class="card-body p-0">
                    @if (isLoading)
                    {
                        <div class="text-center my-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2"><em>Cargando datos...</em></p>
                        </div>
                    }
                    else if (!trayectos.Any())
                    {
                        <div class="alert alert-warning m-2">No se encontraron trayectos.</div>
                    }
                    else
                    {
                        <div class="card mb-2 mx-2 mt-2">
                            <div class="card-body py-2">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-semibold">ID Trayecto</label>
                                        <input type="text" class="form-control form-control-sm"
                                               placeholder="Buscar por ID Trayecto..."
                                               @bind="filtroBusqueda" @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-semibold">Fecha</label>
                                        <input type="date" class="form-control form-control-sm"
                                               @bind="filtroFecha" @bind:event="oninput" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(filtroBusqueda) || filtroFecha != null)
                        {
                            var resultados = trayectos
                            .Where(t =>
                            (string.IsNullOrEmpty(filtroBusqueda) || t.Key.ToString().Contains(filtroBusqueda)) &&
                            (filtroFecha == null || t.Value.First().FechaTrabajo.Date == filtroFecha.Value.Date)
                            ).ToList();

                            @if (!resultados.Any())
                            {
                                <div class="alert alert-danger m-2">No se encontraron trayectos.</div>
                            }
                            else
                            {
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th></th>
                                            <th>ID Trayecto</th>
                                            <th>Fecha</th>
                                            <th class="text-end">Palets Totales</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var trayecto in resultados)
                                        {
                                            var estaExpandido = trayectosExpandidos.Contains(trayecto.Key.ToString());
                                            var estaSeleccionado = trayectoSeleccionado == trayecto.Key;

                                            <tr class="@(estaSeleccionado ? "table-primary" : "")"
                                                style="cursor:pointer"
                                                @onclick="() => ToggleTrayecto(trayecto.Key)">
                                                <td style="width:30px">
                                                    <span>@(estaExpandido ? "▾" : "▸")</span>
                                                </td>
                                                <td><strong>@trayecto.Key</strong></td>
                                                <td>@trayecto.Value.First().FechaTrabajo.ToShortDateString()</td>
                                                <td class="text-end">@trayecto.Value.Sum(c => c.NumeroPalets)</td>
                                            </tr>

                                            @if (estaExpandido)
                                            {
                                                <tr class="table-secondary">
                                                    <td></td>
                                                    <td class="fw-semibold">Tipo Palets</td>
                                                    <td class="fw-semibold">Mercancia</td>
                                                    <td class="text-end fw-semibold">Palets</td>
                                                </tr>
                                                @foreach (var carga in trayecto.Value)
                                                {
                                                    <tr class="table-light" style="cursor:pointer"
                                                        @onclick="() => ToggleTrayecto(trayecto.Key)">
                                                        <td></td>
                                                        <td class="text-muted fst-italic">📦 @carga.TipoPalets</td>
                                                        <td class="text-muted fst-italic">@carga.Mercancia</td>
                                                        <td class="text-end text-muted">@carga.NumeroPalets</td>
                                                    </tr>
                                                }
                                            }
                                        }
                                    </tbody>
                                </table>
                            }
                        }
                        else
                        {
                            <table class="table table-hover mb-0">
                                <tbody>
                                    @foreach (var anyo in trayectosPorAnyoMes)
                                    {
                                        var anyoExpandido = anyosExpandidos.Contains(anyo.Key);

                                        <tr class="table-secondary fw-bold"
                                            style="cursor:pointer"
                                            @onclick="() => ToggleAnyo(anyo.Key)">
                                            <td style="width:30px">
                                                <span>@(anyoExpandido ? "▾" : "▸")</span>
                                            </td>
                                            <td colspan="3">📅 @anyo.Key</td>
                                        </tr>

                                        @if (anyoExpandido)
                                        {
                                            @foreach (var mes in anyo.Value)
                                            {
                                                var mesKey = $"{anyo.Key}-{mes.Key}";
                                                var mesExpandido = mesesExpandidos.Contains(mesKey);

                                                <tr class="table-light fw-semibold"
                                                    style="cursor:pointer"
                                                    @onclick="() => ToggleMes(mesKey)">
                                                    <td class="ps-3" style="width:30px">
                                                        <span>@(mesExpandido ? "▾" : "▸")</span>
                                                    </td>
                                                    <td colspan="3" class="ps-3">
                                                        🗓️ @NombreMes(mes.Key)
                                                    </td>
                                                </tr>

                                                @if (mesExpandido)
                                                {
                                                    <tr class="table-dark">
                                                        <th></th>
                                                        <th>ID Trayecto</th>
                                                        <th>Fecha</th>
                                                        <th class="text-end">Palets Totales</th>
                                                    </tr>
                                                    @foreach (var trayecto in mes.Value)
                                                    {
                                                        var estaExpandido = trayectosExpandidos.Contains(trayecto.Key.ToString());
                                                        var estaSeleccionado = trayectoSeleccionado == trayecto.Key;

                                                        <tr class="@(estaSeleccionado ? "table-primary" : "")"
                                                            style="cursor:pointer"
                                                            @onclick="() => ToggleTrayecto(trayecto.Key)">
                                                            <td class="ps-4" style="width:30px">
                                                                <span>@(estaExpandido ? "▾" : "▸")</span>
                                                            </td>
                                                            <td><strong>@trayecto.Key</strong></td>
                                                            <td>@trayecto.Value.First().FechaTrabajo.ToShortDateString()</td>
                                                            <td class="text-end">@trayecto.Value.Sum(c => c.NumeroPalets)</td>
                                                        </tr>

                                                        @if (estaExpandido)
                                                        {
                                                            <tr class="table-secondary">
                                                                <td></td>
                                                                <td class="fw-semibold">Tipo Palets</td>
                                                                <td class="fw-semibold">Mercancia</td>
                                                                <td class="text-end fw-semibold">Palets</td>
                                                            </tr>
                                                            @foreach (var carga in trayecto.Value)
                                                            {
                                                                <tr class="table-light" style="cursor:pointer"
                                                                    @onclick="() => ToggleTrayecto(trayecto.Key)">
                                                                    <td></td>
                                                                    <td class="text-muted fst-italic">📦 @carga.TipoPalets</td>
                                                                    <td class="text-muted fst-italic">@carga.Mercancia</td>
                                                                    <td class="text-end text-muted">@carga.NumeroPalets</td>
                                                                </tr>
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                </tbody>
                            </table>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-7">
            @if (trayectoSeleccionado != null)
            {
                var cargas = trayectos[trayectoSeleccionado.Value];
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Carga del trayecto <strong>@trayectoSeleccionado</strong>
                            - @cargas.First().FechaTrabajo.ToShortDateString()
                            - @cargas.Sum(p => p.NumeroPalets) palets totales
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="truckMap" style="height:300px; width:900px;"></div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info mt-2">
                    Selecciona un trayecto para ver la distribución de carga.
                </div>
            }
        </div>
    </div>
</div>

<br />

@code {
    private IJSObjectReference? _module;
    private bool _disposed;
    private bool isLoading = true;
    private int clienteId = 212;

    private Dictionary<int, List<PaletsTotales>> trayectos = new();
    private Dictionary<int, Dictionary<int, Dictionary<int, List<PaletsTotales>>>> trayectosPorAnyoMes = new();

    private int? trayectoSeleccionado;
    private HashSet<int> anyosExpandidos = new();
    private HashSet<string> mesesExpandidos = new();
    private HashSet<string> trayectosExpandidos = new();

    private string? nombreCliente;
    private string? filtroBusqueda;
    private DateTime? filtroFecha;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var datos = await ConsultaService.GetCarga(clienteId);

            nombreCliente = datos.First().NombreCliente;

            trayectos = datos.GroupBy(p => p.Trayecto).ToDictionary(g => g.Key, g => g.ToList());

            trayectosPorAnyoMes = trayectos.GroupBy(t => t.Value.First().FechaTrabajo.Year)
                                           .OrderByDescending(g => g.Key)
                                           .ToDictionary(
                                                gAnyo => gAnyo.Key,
                                                gAnyo => gAnyo
                                                      .GroupBy(t => t.Value.First().FechaTrabajo.Month)
                                                      .OrderBy(g => g.Key)
                                                      .ToDictionary(
                                                          gMes => gMes.Key,
                                                          gMes => gMes
                                                               .OrderBy(t => t.Value.First().FechaTrabajo)
                                                               .ToDictionary(t => t.Key, t => t.Value)
                                                      )
                                            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleAnyo(int anyo)
    {
        if (anyosExpandidos.Contains(anyo))
            anyosExpandidos.Remove(anyo);
        else
            anyosExpandidos.Add(anyo);
    }

    private void ToggleMes(string mesKey)
    {
        if (mesesExpandidos.Contains(mesKey))
            mesesExpandidos.Remove(mesKey);
        else
            mesesExpandidos.Add(mesKey);
    }

    private async Task ToggleTrayecto(int idTrayecto)
    {
        if (trayectosExpandidos.Contains(idTrayecto.ToString()))
            trayectosExpandidos.Remove(idTrayecto.ToString());
        else
            trayectosExpandidos.Add(idTrayecto.ToString());

        trayectoSeleccionado = idTrayecto;
        StateHasChanged();

        await Task.Delay(50);
        await RenderRemolque();
    }

    private static string NombreMes(int mes) => mes switch
    {
        1 => "Enero",
        2 => "Febrero",
        3 => "Marzo",
        4 => "Abril",
        5 => "Mayo",
        6 => "Junio",
        7 => "Julio",
        8 => "Agosto",
        9 => "Septiembre",
        10 => "Octubre",
        11 => "Noviembre",
        12 => "Diciembre",
        _ => mes.ToString()
    };

    protected async Task RenderRemolque()
    {
        if (trayectoSeleccionado == null || _disposed)
            return;

        var cargas = trayectos[trayectoSeleccionado.Value];

        var tiposEuropalet = new[] { "H", "E", "N", "NE" };

        double espacioOcupado = cargas.Sum(c =>
            tiposEuropalet.Contains(c.TipoPalets)
                ? (double)c.NumeroPalets / 33
                : (double)c.NumeroPalets / 26
        );

        double espacioLibre = Math.Max(0, 1 - espacioOcupado);

        var datos = cargas.Select(c => new
        {
            label = c.TipoPalets,
            value = Math.Round(
                tiposEuropalet.Contains(c.TipoPalets)
                    ? (double) c.NumeroPalets / 33 * 100
                    : (double) c.NumeroPalets / 26 * 100
                , 1)
        }).ToList<object>();

        if(espacioLibre > 0)
        {
            datos.Add(new
            {
                label = "Libre",
                valueKey = "Espacio libre",
                value = Math.Round(espacioLibre * 100, 1)
            });
        }

        try
        {
            _module ??= await JS.InvokeAsync<IJSObjectReference>(
                "import", "/js/remolqueChart.js");

            await _module.InvokeVoidAsync("initRemolque", "truckMap");
            await _module.InvokeVoidAsync("updateRemolque", datos, new
            {
                showLabels = true,
                labelKey = "label",
                valueKey = "value",
                padding = 12,
                emptyLabel = "Libre"
            });
        }
        catch (JSDisconnectedException) { }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando remolque: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_disposed)
            return;

        _disposed = true;

        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch { }
        }
    }
}
