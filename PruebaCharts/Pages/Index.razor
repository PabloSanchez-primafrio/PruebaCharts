@page "/"
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Index</PageTitle>
<h1>🚛 Gestión de Cargas del Remolque</h1>
<div id="truckMap" style="height:500px;"></div>

@code {
    private IJSObjectReference? _module;
    private bool _disposed;
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_initialized && !_disposed)
        {
            _initialized = true;

            try
            {
                _module = await JS.InvokeAsync<IJSObjectReference>(
                    "import", "/js/remolqueChart.js");

                await _module.InvokeVoidAsync("initRemolque", "truckMap");

                var cargas = await ObtenerCargasDesdeBDAsync();
                await _module.InvokeVoidAsync("updateRemolque", cargas, new
                {
                    showLabels = true,
                    labelKey = "label",
                    valueKey = "value",
                    padding = 12
                });
            }
            catch (JSDisconnectedException)
            {
                _initialized = false;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error inicializando remolque: {ex.Message}");
                _initialized = false;
            }
        }
    }

    private Task<List<object>> ObtenerCargasDesdeBDAsync()
    {
        var lista = new List<object>
        {
            new { label = "C001", value = 35 },
            new { label = "C002", value = 55 },
            new { label = "C003", value = 80 },
            new { label = "C004", value = 20 },
            new { label = "C005", value = 65 },
            new { label = "C006", value = 10 }
        };
        return Task.FromResult(lista);
    }

    public async ValueTask DisposeAsync()
    {
        if (_disposed)
            return;

        _disposed = true;
        _initialized = false;

        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch
            {
                // Ignora errores
            }
        }
    }
}