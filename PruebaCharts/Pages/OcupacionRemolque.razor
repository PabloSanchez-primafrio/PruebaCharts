@page "/ocupacion"

@inject IJSRuntime JS
@inject ConsultaService ConsultaService
@implements IAsyncDisposable

<h3>Gauge ECharts</h3>

<div id="gauge-container" style="width: 500px; height: 400px;"></div>

<div style="margin-top: 20px;">
    <label>Valor: <strong>@CurrentValue</strong></label>
    <br />
    <input type="range" min="0" max="100" step="1"
           @oninput="OnSliderChanged"
           value="@CurrentValue"
           style="width: 300px;" />
</div>

@code {
    private double CurrentValue { get; set; } = 65;
    private IJSObjectReference? _echartsInstance;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _echartsInstance = await JS.InvokeAsync<IJSObjectReference>("eval", $$"""
                (() => {
                    const dom = document.getElementById('gauge-container');
                    const chart = echarts.init(dom);

                    function buildOption(value){
                        return {
                            series: [{
                                type: 'gauge',
                                startAngle: 200,
                                endAngle: -20,
                                min: 0,
                                max: 100,
                                splitNumber: 10,
                                progress: {
                                    show: true,
                                    roundCap: true,
                                    width: 18
                                },
                                axisLine: {
                                    roundCap: true,
                                    lineStyle: { width: 18 }
                                },
                                axisTick: {
                                    splitNumber: 2,
                                    lineStyle: { width: 2, color: '#999' }
                                },
                                splitLine: {
                                    length: 12,
                                    lineStyle: { width: 3, color: '#999' }
                                },
                                axisLabel: {
                                    distance: 30,
                                    color: '#999',
                                    fontSize: 14
                                },
                                detail: {
                                    valueAnimation: true,
                                    formatter: '{value}%',
                                    fontSize: 28,
                                    offsetCenter: [0, '55%'],
                                    color: '#58D9F9'
                                },
                                title: {
                                    offsetCenter: [0, '30%'],
                                    fontSize: 18,
                                    color: '#58D9F9'
                                },
                                data: [{ value: value, name: 'Progreso' }]
                            }]
                        };
                    }
                    chart.setOption(buildOption({{CurrentValue}}));

                    return {
                        update: (v) => chart.setOption({ series: [{ data: [{ value: v, name: 'Progreso' }] }] }),
                        dispose: () => chart.dispose()
                    };
                })()
            """);
        }
    }

    private async Task OnSliderChanged(ChangeEventArgs e)
    {
        if(double.TryParse(e.Value?.ToString(), out double val))
        {
            CurrentValue = val;
            if(_echartsInstance is not null)
            {
                await _echartsInstance.InvokeVoidAsync("update", CurrentValue);
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if(_echartsInstance is not null)
        {
            await _echartsInstance.InvokeVoidAsync("dispose");
            await _echartsInstance.DisposeAsync();
        }
    }

}
